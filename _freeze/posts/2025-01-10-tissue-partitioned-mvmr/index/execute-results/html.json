{
  "hash": "2bb1f9fe3b86a3b4c84126c67b46d25f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Tissue-partitioned BMI instrument procedure\"\nauthor: \"Nick Sunderland\"\ndate: \"2025-01-10\"\nexecute:\n  fig-path: \"posts/2025-01-10-tissue-partitioned-mvmr/\" \n---\n\n\n\n## Motivation\nWhat does the weighting by PPH4 do to tissue partitioned BMI instruments? Let's simulate some tissue partitioned BMI MR results.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nlibrary(ggplot2)\nlibrary(ggpubr)\nlibrary(genepi.utils)\nlibrary(tibble)\nlibrary(knitr)\n```\n:::\n\n\n\n\n## BMI data\nFirst load the BMI GWAS.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbmi    <- readRDS(file.path(TPMR_DIR, \"output\", \"tmp_objects\", \"obj_bmi.RDS\"))\nclumps <- clump(as.data.table(bmi), p1=5e-8, r2=0.001, kb=10000, plink2=PLINK2, plink_ref=UKBB_REFERENCE)[index==TRUE]\nbmi    <- subset_gwas(bmi, clumps$rsid)\nkable(head(clumps, 5), caption = \"BMI lead variants\")\n```\n\n::: {.cell-output-display}\n\n\nTable: BMI lead variants\n\n|rsid       |chr |        bp|ea |oa |      eaf|       beta|        se|  p|      n| ncase|trait |id                               |strand |imputed | info|  q| q_p| i2|proxy_rsid |proxy_chr | proxy_bp|proxy_ea |proxy_oa | proxy_eaf| proxy_r2|snp        |index |clump |\n|:----------|:---|---------:|:--|:--|--------:|----------:|---------:|--:|------:|-----:|:-----|:--------------------------------|:------|:-------|----:|--:|---:|--:|:----------|:---------|--------:|:--------|:--------|---------:|--------:|:----------|:-----|:-----|\n|rs10007906 |4   |  31023610|A  |C  | 0.360300|  0.0133000| 0.0018000|  0| 686479|    NA|bmi   |combined_bmi_giant_ukb_annot.txt |NA     |NA      |   NA| NA|  NA| NA|NA         |NA        |       NA|NA       |NA       |        NA|       NA|rs10007906 |TRUE  |291   |\n|rs1000940  |17  |   5283252|A  |G  | 0.701300| -0.0154000| 0.0018000|  0| 794558|    NA|bmi   |combined_bmi_giant_ukb_annot.txt |NA     |NA      |   NA| NA|  NA| NA|NA         |NA        |       NA|NA       |NA       |        NA|       NA|rs1000940  |TRUE  |142   |\n|rs1007934  |14  |  73463479|A  |G  | 0.415000| -0.0120000| 0.0017000|  0| 692411|    NA|bmi   |combined_bmi_giant_ukb_annot.txt |NA     |NA      |   NA| NA|  NA| NA|NA         |NA        |       NA|NA       |NA       |        NA|       NA|rs1007934  |TRUE  |407   |\n|rs10125137 |9   | 118644190|T  |C  | 0.641786| -0.0117273| 0.0020523|  0| 463005|    NA|bmi   |combined_bmi_giant_ukb_annot.txt |NA     |NA      |   NA| NA|  NA| NA|NA         |NA        |       NA|NA       |NA       |        NA|       NA|rs10125137 |TRUE  |811   |\n|rs10131890 |14  |  97258752|A  |C  | 0.950300| -0.0222000| 0.0039000|  0| 691777|    NA|bmi   |combined_bmi_giant_ukb_annot.txt |NA     |NA      |   NA| NA|  NA| NA|NA         |NA        |       NA|NA       |NA       |        NA|       NA|rs10131890 |TRUE  |846   |\n\n\n:::\n:::\n\n\n\n## Heart failure data\nLoad the heart failure GWAS.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhf <- readRDS(file.path(TPMR_DIR, \"output\", \"tmp_objects\", \"obj_hf_allcause.RDS\"))\nhf <- subset_gwas(hf, clumps$rsid)\n```\n:::\n\n\n\n## Harmonise the datasets\n\n\n::: {.cell}\n\n```{.r .cell-code}\nh <- MR(bmi, hf)\nkable(head(as.data.table(h),5), caption = \"Harmonised BMI:HF dataset\")\n```\n\n::: {.cell-output-display}\n\n\nTable: Harmonised BMI:HF dataset\n\n|rsid           |chr |        bp|ea |oa |         bx|      bxse| px|      by|   byse|      py|proxy_e_snp |proxy_o_snp |index_snp | group|ld_info |exposure |outcome     |\n|:--------------|:---|---------:|:--|:--|----------:|---------:|--:|-------:|------:|-------:|:-----------|:-----------|:---------|-----:|:-------|:--------|:-----------|\n|rs10007906_C_A |4   |  31023610|A  |C  |  0.0133000| 0.0018000|  0|  0.0039| 0.0051| 0.44980|NA          |NA          |TRUE      |    NA|FALSE   |bmi      |hf_allcause |\n|rs1000940_G_A  |17  |   5283252|A  |G  | -0.0154000| 0.0018000|  0|  0.0011| 0.0050| 0.82970|NA          |NA          |TRUE      |    NA|FALSE   |bmi      |hf_allcause |\n|rs1007934_G_A  |14  |  73463479|A  |G  | -0.0120000| 0.0017000|  0| -0.0092| 0.0049| 0.05931|NA          |NA          |TRUE      |    NA|FALSE   |bmi      |hf_allcause |\n|rs10125137_C_T |9   | 118644190|T  |C  | -0.0117273| 0.0020523|  0|  0.0033| 0.0049| 0.50820|NA          |NA          |TRUE      |    NA|FALSE   |bmi      |hf_allcause |\n|rs10131890_C_A |14  |  97258752|A  |C  | -0.0222000| 0.0039000|  0| -0.0211| 0.0099| 0.03310|NA          |NA          |TRUE      |    NA|FALSE   |bmi      |hf_allcause |\n\n\n:::\n:::\n\n\n\n## Run the MR\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- run_mr(h)\nkable(res, caption = \"BMI:HF Mendelian randomisation\")\n```\n\n::: {.cell-output-display}\n\n\nTable: BMI:HF Mendelian randomisation\n\n|method             |correlation |exposure |outcome     | n_snp|         b|      b_se|  p|  intercept|    int_se|     int_p|    qstat| qstat_p|    fstat| condfstat| overdispersion| n_pc| n_hunted| slopehunter_pi| slopehunter_ent|\n|:------------------|:-----------|:--------|:-----------|-----:|---------:|---------:|--:|----------:|---------:|---------:|--------:|-------:|--------:|---------:|--------------:|----:|--------:|--------------:|---------------:|\n|mr_ivw             |FALSE       |bmi      |hf_allcause |   874| 0.4872820| 0.0165599|  0|  0.0000000|        NA|        NA| 1592.460|       0| 60.70091|        NA|             NA|   NA|       NA|             NA|              NA|\n|mr_egger           |FALSE       |bmi      |hf_allcause |   874| 0.5367727| 0.0464790|  0| -0.0008232| 0.0007224| 0.2544728| 1590.092|       0|       NA|        NA|             NA|   NA|       NA|             NA|              NA|\n|mr_weighted_median |FALSE       |bmi      |hf_allcause |   874| 0.5078217| 0.0236696|  0|  0.0000000|        NA|        NA|       NA|      NA|       NA|        NA|             NA|   NA|       NA|             NA|              NA|\n|mr_weighted_mode   |FALSE       |bmi      |hf_allcause |   874| 0.5456300| 0.0523114|  0|  0.0000000|        NA|        NA|       NA|      NA|       NA|        NA|             NA|   NA|       NA|             NA|              NA|\n\n\n:::\n:::\n\n\n\n## Plot MR\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_mr(h, res)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n## Select variants - MR with a subset of BMI variants\nIn the Leyden et al. 2022 paper 86 variant colocalise with adipose tissue eQTLs and 140 colocalise with brain tissue eQTLs. There is overlap between the two tissues of 43 variants.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\ntissue1_varid <- sample(h@snps, 140)\noverlap_varid <- sample(tissue1_varid, 43)\ntissue2_varid <- c(overlap_varid, sample(h@snps[!h@snps %in% overlap_varid], 86-43))\n\n# turn of variants not in either tissue\nh@index_snp[!h@snps %in% c(tissue1_varid, tissue2_varid)] <- FALSE\nh@exposure <- \"BMI tissue 1/2 SNPs\"\n\nres1 <- run_mr(h)\nkable(res1, caption = \"BMI:HF Mendelian randomisation (Tissue 1 & 2 SNPs only)\")\n```\n\n::: {.cell-output-display}\n\n\nTable: BMI:HF Mendelian randomisation (Tissue 1 & 2 SNPs only)\n\n|method             |correlation |exposure            |outcome     | n_snp|         b|      b_se|     p|  intercept|    int_se|     int_p|    qstat| qstat_p|    fstat| condfstat| overdispersion| n_pc| n_hunted| slopehunter_pi| slopehunter_ent|\n|:------------------|:-----------|:-------------------|:-----------|-----:|---------:|---------:|-----:|----------:|---------:|---------:|--------:|-------:|--------:|---------:|--------------:|----:|--------:|--------------:|---------------:|\n|mr_ivw             |FALSE       |BMI tissue 1/2 SNPs |hf_allcause |   177| 0.5108471| 0.0363407| 0e+00|  0.0000000|        NA|        NA| 304.2402|       0| 61.28134|        NA|             NA|   NA|       NA|             NA|              NA|\n|mr_egger           |FALSE       |BMI tissue 1/2 SNPs |hf_allcause |   177| 0.5475313| 0.1037260| 1e-07| -0.0006034| 0.0015974| 0.7056336| 303.9924|       0|       NA|        NA|             NA|   NA|       NA|             NA|              NA|\n|mr_weighted_median |FALSE       |BMI tissue 1/2 SNPs |hf_allcause |   177| 0.5730810| 0.0494983| 0e+00|  0.0000000|        NA|        NA|       NA|      NA|       NA|        NA|             NA|   NA|       NA|             NA|              NA|\n|mr_weighted_mode   |FALSE       |BMI tissue 1/2 SNPs |hf_allcause |   177| 0.5887868| 0.1022882| 0e+00|  0.0000000|        NA|        NA|       NA|      NA|       NA|        NA|             NA|   NA|       NA|             NA|              NA|\n\n\n:::\n\n```{.r .cell-code}\nplot_mr(h, res1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n## Run multivariable MR (unweighted)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# copy of BMI for tissue 1\nbmi_t1 <- bmi\nbmi_t1@id <- \"bmi tissue 1\"\nbmi_t1@trait <- \"bmi tissue 1\"\n\n# copy of BMI for tissue 2\nbmi_t2 <- bmi\nbmi_t2@id <- \"bmi tissue 2\"\nbmi_t2@trait <- \"bmi tissue 2\"\n\n# harmonise\nh_mvmr <- MR(list(bmi_t1, bmi_t2), hf)\n\n# turn of variants not in either tissue\nh_mvmr@index_snp[!h_mvmr@snps %in% c(tissue1_varid, tissue2_varid)] <- FALSE\n\nres2 <- run_mr(h_mvmr, methods=\"mr_ivw\")\nkable(res2, caption = \"BMI:HF MV Mendelian randomisation\")\n```\n\n::: {.cell-output-display}\n\n\nTable: BMI:HF MV Mendelian randomisation\n\n|method   |correlation |exposure     |outcome     | n_snp|         b|      b_se|  p| intercept| int_se| int_p|    qstat| qstat_p| fstat| condfstat| overdispersion| n_pc| n_hunted| slopehunter_pi| slopehunter_ent|\n|:--------|:-----------|:------------|:-----------|-----:|---------:|---------:|--:|---------:|------:|-----:|--------:|-------:|-----:|---------:|--------------:|----:|--------:|--------------:|---------------:|\n|mr_mvivw |FALSE       |bmi tissue 1 |hf_allcause |   177| 0.5108471| 0.0363407|  0|         0|     NA|    NA| 302.5116|       0|    NA|         0|             NA|   NA|       NA|             NA|              NA|\n|mr_mvivw |FALSE       |bmi tissue 2 |hf_allcause |   177| 0.5108471| 0.0363407|  0|         0|     NA|    NA| 302.5116|       0|    NA|         0|             NA|   NA|       NA|             NA|              NA|\n\n\n:::\n\n```{.r .cell-code}\nplot_mr(h_mvmr, res2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n## eQTL colocalising BMI variants\n\n### Number of colocalising variants per tissue\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoloc_thresh <- 0.8\n\ncoloc_results <- fread(file.path(TPMR_DIR, \"output\", \"tables\", \"coloc_results.tsv.gz\"))\ncoloc_counts <- coloc_results[locus_trait==\"bmi\" & grepl(\"^bmi\", trait.x) & !grepl(\"^bmi|^hf_\", trait.y), .SD[which.max(pph4)], by=.(locus_index_rsid,trait.y)][, .(`num_coloc_pph4` = sum(pph4>coloc_thresh)), by=c(tissue=\"trait.y\")][, tissue := factor(tissue, levels = tissue[order(-`num_coloc_pph4`)])]\n\nggplot(coloc_counts, aes(y = tissue, x = `num_coloc_pph4`)) +\n  theme_classic() +\n  geom_col(fill= \"blue\", alpha = 0.3) +\n  labs(subtitle = paste(\"coloc thresh:\", coloc_thresh), \n       x = \"Number of colocalising BMI variants\") +\n  theme(axis.title.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n### Determinants of colocalisation number\nDoes this depend on eqtl sample size????\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(cars)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n### Effect of number of colocalising loci on MVMR result - 1\nSimple analysis: hold constant the number of colocalising variants in tissue 1 (set to median: 91) and hold the PPH4 weighting for colocalising variants at `0.9` and the for the non-colocalising variants at `0.2`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnum_loci <- expand.grid(num_t1  = round(median(coloc_counts$num_coloc_pph4)), \n                        num_t2  = seq(min(coloc_counts$num_coloc_pph4), max(coloc_counts$num_coloc_pph4)),\n                        pph4_hi = 0.9, \n                        pph4_lo = 0.2) |> as.data.table()\n\nunique_num_loci <- sort(unique(c(num_loci$num_t1, num_loci$num_t2)))\nunique_num_loci <- setNames(unique_num_loci, as.character(unique_num_loci))\n\nloci_indicies <- lapply(unique_num_loci, function(num_l) {\n  set.seed(123)\n  sample(1:length(h_mvmr@snps), num_l, replace = FALSE)\n})\n\nmr_num_loci <- num_loci[, {\n  h_tmp   <- copy(h_mvmr)\n  t1_incides <- loci_indicies[[as.character(num_t1)]]\n  t2_incides <- loci_indicies[[as.character(num_t2)]]\n  h_tmp@index_snp <- ifelse(1:length(h_tmp@snps) %in% union(t1_incides, t2_incides), TRUE, FALSE) \n  h_tmp@bx[t1_incides,1] <- h_tmp@bx[t1_incides,1] * pph4_hi\n  h_tmp@bx[t2_incides,2] <- h_tmp@bx[t2_incides,2] * pph4_hi\n  h_tmp@bx[setdiff(t2_incides, t1_incides),1] <- h_tmp@bx[setdiff(t2_incides, t1_incides),1] * pph4_lo\n  h_tmp@bx[setdiff(t1_incides, t2_incides),2] <- h_tmp@bx[setdiff(t1_incides, t2_incides),2] * pph4_lo\n  h_tmp@exposure <- c(\"Tissue 1\", \"Tissue 2\")\n  r <- run_mr(h_tmp, methods=\"mr_ivw\")\n}, by = .(num_t1, num_t2)]\n\nggplot(mr_num_loci, aes(x=num_t2, y=exp(b), ymin=exp(b-b_se*1.96), ymax=exp(b+b_se*1.96), color=exposure)) +\n  geom_errorbar(width=0.2, position = position_dodge(0.2)) +\n  geom_point(position = position_dodge(0.2)) +\n  labs(y = \"MVMR estimate (tpBMI vs HF)\", \n       x = \"Number of tissue 2 loci\", \n       color = \"Tissue\", \n       subtitle = paste0(\"Number of loci for tissue 1 fixed at \", num_loci$num_t1[1]))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n### Effect of number of colocalising loci on MVMR result - 2\nNow do the same but vary both the number of colocalising variants in tissue 1 and 2 (grid search).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnum_loci <- expand.grid(num_t1  = seq(min(coloc_counts$num_coloc_pph4), max(coloc_counts$num_coloc_pph4), 40), \n                        num_t2  = seq(min(coloc_counts$num_coloc_pph4), max(coloc_counts$num_coloc_pph4), 40),\n                        overlap = seq(0, 1, 0.2),\n                        seed    = 2000:2050,\n                        pph4_hi = 0.9, \n                        pph4_lo = 0.1) |> as.data.table()\n\nlibrary(future)\nlibrary(furrr)\nplan(multisession)\nmr_num_loci <- future_pmap_dfr(num_loci, function(num_t1, num_t2, overlap, seed, pph4_hi, pph4_lo) {\n  \n  h_tmp   <- copy(h_mvmr)\n  \n  # randomly sort the BMI SNP indices\n  set.seed(seed)\n  sram_idx <- sample.int(length(h_mvmr@snps))\n  \n  # indicies of the variants to use\n  overlap_n <- round(min(num_t1, num_t2) * overlap)\n  t1i       <- sram_idx[1:num_t1]\n  t2i       <- sram_idx[(num_t1-overlap_n+1):(num_t2 + num_t1-overlap_n)]\n  t12i      <- intersect(t1i, t2i)  # both tissues\n  ut1i      <- setdiff(t1i, t12i)   # only tissue 1\n  ut2i      <- setdiff(t2i, t12i)   # only tissue 2\n  \n  # which snps go into the instrument\n  h_tmp@index_snp <- 1:length(h_mvmr@snps) %in% c(t12i, ut1i, ut2i)\n  \n  # weight tissue 1 betas\n  h_tmp@bx[ut2i,1] <- h_tmp@bx[ut2i,1] * pph4_lo \n  h_tmp@bx[t1i,1]  <- h_tmp@bx[t1i,1] * pph4_hi \n  \n  # weight tissue 2 betas\n  h_tmp@bx[ut1i,2] <- h_tmp@bx[ut1i,2] * pph4_lo \n  h_tmp@bx[t2i,2]  <- h_tmp@bx[t2i,2] * pph4_hi \n  \n  # naming\n  h_tmp@exposure <- c(\"MV-beta tissue 1\", \"MV-beta tissue 2\")\n  \n  # run mr\n  r <- run_mr(h_tmp, methods=\"mr_ivw\")\n  \n  r[, `:=`(num_t1   = num_t1, \n           num_t2   = num_t2, \n           num_diff = num_t1-num_t2, \n           overlap  = overlap, \n           seed     = seed, \n           pph4_lo  = pph4_lo, \n           pph4_hi  = pph4_hi)]\n  \n  return(r)\n})\n\n\nggplot(mr_num_loci, aes(x=as.factor(num_diff), y=b, fill=exposure, color=num_t1)) +\n  geom_hline(yintercept = 0.0, linetype=\"dashed\", color=\"darkgray\") +\n  geom_violin(width=1, position= position_dodge(width = 0.5), color=NA) +\n  theme_classic() +\n  labs(x = \"Difference in instrument size (num SNPs, T1-T2)\", \n       y = \"MVMR estimate\", \n       fill = \"Tissue\") +\n  facet_wrap(~overlap, \n             #scales = \"free\", \n             labeller = labeller(overlap = function(x) paste0(\"Loci overlap: \", scales::percent(as.numeric(x)))))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\n## BMI:eQTL PPH4 distributions by tissue\nNow lets look at the actual distributions of the PPH4 values in each tissue, since they are not fixed like in the above analyses. Take the maximum PPH4 from genes in close proximity to each variant, in each tissue and plot the distributions - these are the weights that would be used in the tissue-partitioned MR procedure. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnum_tissues <- 6\ntissues_subset <- levels(coloc_counts$tissue)[as.integer(seq(1, length(levels(coloc_counts$tissue)), length.out=num_tissues))] \ncoloc_subset <- coloc_results[locus_trait==\"bmi\" & trait.x==\"bmi\" & (trait.y %in% tissues_subset), .SD[which.max(pph4)], by=.(locus_index_rsid,trait.y)]\n\ndensity <- coloc_subset[, {\n  den <- density(pph4, n=1000)\n  .(pph4 = scales::rescale(den$x, 0:1), prob = den$y)\n}, by = c(tissue=\"trait.y\")][, tissue := factor(tissue, levels = levels(coloc_counts$tissue))]\n\nggplot(density, aes(x=pph4, y=prob, color=tissue)) +\n  theme_classic() +\n  geom_line() +\n  labs(y = \"Density\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n## Use of these distributions in simulations \nIf we want 'real-world' PPH4 weights for use in simulations we can just sample from these density distributions. Here is a quick check to show that sampling from them replicates the shape.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntissues <- expand.grid(tissue = unique(density$tissue), stringsAsFactors = F) |> as.data.table()\n\nset.seed(123)\n\nres_sim_density <- tissues[, {\n  .(sim_pph4 = sample(density[tissue==.BY$tissue, pph4], round(length(h_mvmr@bx[,1])/2), prob = density[tissue==.BY$tissue, prob], replace = TRUE))\n}, by = .(tissue)]\n\n\nggplot(res_sim_density, aes(x=sim_pph4, color=tissue)) +\n  theme_classic() +\n  geom_density() +\n  labs(y = \"Simulated density\", \n       x = \"Simulated PPH4\", \n       color = \"Tissue\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n## Effect different PPH4 weights\nWeight the BMI betas by their respective maximum PPH4 value, see how this changes the relationship between the beta for BMI and beta for HF, dependent on which tissue is providing the betas. Tissues with greater or fewer colocalising variants affect push the betas up or down more, respectively. I hold one tissue constant (reference) to more easily appreciate how the other tissue's colocalisation characteristics affect things. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nref_tissue   <- levels(density$tissue)[1]\ntissue_pairs <- expand.grid(t1 = ref_tissue, t2 = unique(density$tissue), stringsAsFactors = F) |> as.data.table()\n\nset.seed(123)\nt1_pph4 <- sample(density[tissue==ref_tissue, pph4], length(h_mvmr@bx[,1]), prob = density[tissue==ref_tissue, prob], replace = TRUE)\n\nres_weighted <- tissue_pairs[, {\n  h_tmp <- h_mvmr\n  t2_pph4 <- sample(density[tissue==.BY$t2, pph4], length(h_tmp@bx[,1]), prob = density[tissue==.BY$t2, prob], replace = TRUE)\n  h_tmp@bx[,1] <- h_tmp@bx[,1] * t1_pph4\n  h_tmp@bx[,2] <- h_tmp@bx[,2] * t2_pph4\n  h_tmp@index_snp <- ifelse(t1_pph4>coloc_thresh | t2_pph4>coloc_thresh, TRUE, FALSE)\n  .(tissue   = rep(c(paste0(\"Ref: \", ref_tissue),\"Comparator\"), each=sum(h_tmp@index_snp)), \n    beta_bmi = c(h_tmp@bx[h_tmp@index_snp,1], h_tmp@bx[h_tmp@index_snp,2]), \n    beta_hf  = rep(h_tmp@by[h_tmp@index_snp],2),\n    mean_pph4_t1 = mean(t1_pph4[t1_pph4>coloc_thresh | t2_pph4>coloc_thresh]),\n    mean_pph4_t2 = mean(t2_pph4[t1_pph4>coloc_thresh | t2_pph4>coloc_thresh]), \n    rmse_pph4    = sqrt(mean((t1_pph4[t1_pph4>coloc_thresh | t2_pph4>coloc_thresh] - t2_pph4[t1_pph4>coloc_thresh | t2_pph4>coloc_thresh])^2))\n   )\n}, by = .(t1,t2)]\nres_weighted[, t2 := factor(t2, levels = unique(t2[order(-mean_pph4_t1)]))]\n\nggplot(res_weighted, aes(x=beta_bmi, y=beta_hf, color=tissue)) +\n  geom_point() +\n  geom_text(data = unique(res_weighted[grepl(\"Ref\", tissue)], by=\"t2\"), \n            aes(x = 0.0, \n                y = -0.04,\n                label = sprintf(\"Tis mPPH4=%.3f\", mean_pph4_t2)),\n            color=\"black\", size=2) +\n  geom_text(data = unique(res_weighted[!grepl(\"Ref\", tissue)], by=\"t2\"), \n            aes(x = 0.0, \n                y = -0.07,\n                label = sprintf(\"Ref mPPH4=%.3f\", mean_pph4_t1)),\n            color=\"black\", size=2) +\n  geom_smooth(method=\"lm\", se=F,fullrange = TRUE) +\n  facet_wrap(~t2, labeller = labeller(t2 = function(x) gsub(\"_\", \" \", x))) +\n  labs(subtitle = paste(\"coloc thresh:\", coloc_thresh), \n       y = \"Heart failure beta\", \n       x = \"BMI beta (PPH4-weighted)\", \n       color = \"Tissue\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n## IVW regression by different PPH4 weighting distributions\nPerform MVMR with the weighted BMI instruments. Lets look at holding a poorly colocalising tissue constant compared to the best colocalising tissues.\n\n### Function to weight betas and run MR \n\n\n::: {.cell}\n\n```{.r .cell-code}\n#' @title TPMR helper function\n#' @param mrobj genepi.utils MR object (exposures BMI:BMI, outcome HF)\n#' @param density data.table of PPH4 density distributions cols: tissue | pph4 | prob\n#' @param ref character vector, tissues in density$tissue\n#' @param comp character vector, tissues in density$tissue\n#' @param coloc_thresh numeric 0-1\n#' @param rep integer, number of replications (random sampling of BMI variants into instrument)\n#' @returns data.table of MR results\n#'\ntpmr <- function(obj, density, ref, comp, coloc_thresh, rep = 50) {\n  \n  # run the MR for each of the exposure combinations\n  tissue_pairs <- expand.grid(t1 = as.character(ref), \n                              t2 = as.character(comp),\n                              seed = 2000:(2000+rep),\n                              stringsAsFactors = F) |> as.data.table()\n  \n  library(future)\n  library(furrr)\n  plan(multisession)\n  mr_weighted <- future_pmap_dfr(tissue_pairs, function(t1, t2, seed) {\n    \n    mrobj <- copy(obj)\n    \n    # generate the PPH4 values randomly for the variants\n    set.seed(seed)\n    t1_pph4 <- sample(density[tissue==t1, pph4], length(mrobj@snps), prob = density[tissue==t1, prob], replace = TRUE)\n    set.seed(seed+1)\n    t2_pph4 <- sample(density[tissue==t2, pph4], length(mrobj@snps), prob = density[tissue==t2, prob], replace = TRUE)\n    \n    # based on the distribution of PPH4, which SNPs are included\n    include <- ifelse(t1_pph4 > coloc_thresh | t2_pph4 > coloc_thresh, TRUE, FALSE)\n    \n    # update the MR object, turn off the excluded snps (@index_snp slot)\n    mrobj@bx[,1]      <- mrobj@bx[,1] * t1_pph4\n    mrobj@bx[,2]      <- mrobj@bx[,2] * t2_pph4\n    mrobj@index_snp   <- include\n    mrobj@exposure[1] <- ifelse(length(ref)==1, paste0(\"Ref: \", ref_tissue), \"Tissue 1\")\n    mrobj@exposure[2] <- ifelse(length(ref)==1, \"Comparator\", \"Tissue 2\")\n    \n    # run the MR\n    r <- run_mr(mrobj, methods=\"mr_ivw\")\n    \n    # add info about the instrument used\n    r[, `:=`(t1             = t1, \n             t2             = t2,\n             seed           = seed,\n             n_sig_snps     = c(sum(t1_pph4 > coloc_thresh), sum(t2_pph4 > coloc_thresh)), \n             n_overlap_snps = sum(t1_pph4 > coloc_thresh & t2_pph4 > coloc_thresh),\n             pct_t1_overlap = sum(t1_pph4 > coloc_thresh & t2_pph4 > coloc_thresh) / length(t1_pph4),\n             mean_pph4_t1   = mean(t1_pph4[include]),\n             mean_pph4_t2   = mean(t2_pph4[include]),\n             rmse_pph4      = sqrt(mean((t1_pph4[include] - t2_pph4[include])^2)), \n             rmse_wbeta     = sqrt(mean((mrobj@bx[,1] - mrobj@bx[,2])^2)))]\n    r[, c(\"overdispersion\", \"n_pc\", \"n_hunted\", \"slopehunter_pi\", \"slopehunter_ent\") := NULL]\n    \n})\n#  }, by = .(t1,t2,seed)]\n  \n  return(mr_weighted)\n}\n```\n:::\n\n\n\n\n### Different PPH4 distributions against each other \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# run TPMR\nmr_weighted <- tpmr(obj=h_mvmr, density=density, \n                    ref= unique(density$tissue), \n                    comp=unique(density$tissue), \n                    coloc_thresh=0.8, \n                    rep = 100)\n\n# reorder for plotting \nmr_weighted[, mean_pph4_t1_lab := round(mean(mean_pph4_t1),2), by=.(t1)]\nmr_weighted[, mean_pph4_t2_lab := round(mean(mean_pph4_t2),2), by=.(t2)]\nmr_weighted[, mean_n_sig_snps := round(mean(mean_pph4_t2),0), by=.(t1,t2)]\n\nggplot(mr_weighted, \n       aes(x=as.factor(mean_pph4_t2_lab), y=b, color=exposure)) +\n  geom_boxplot() +\n  theme_bw() +\n  labs(y = \"MVMR estimate\", x = \"T2 mean PPH4\", color = \"Tissue\") +\n  facet_wrap(~ as.factor(mean_pph4_t1_lab), labeller = labeller(`as.factor(mean_pph4_t1_lab)`=function(x) paste0(\"T1 mean PPH4: \",x)))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(mr_weighted[, .(b=mean(b)), by=.(t1,t2,exposure)][, .(b_diff=b[1]-b[2]), by=.(t1,t2)], \n       aes(y=t1, x=t2, fill=b_diff)) +\n  geom_tile() +\n  scale_fill_gradient2() +\n  theme(axis.text.x  = element_text(angle=45, hjust=1)) +\n  labs(y = \"Tissue 1\", x = \"Tissue 2\", fill = \"T1-T2 beta diff\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-2.png){width=672}\n:::\n:::\n\n\n\n## Interpretation\n....",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}