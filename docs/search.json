[
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "Miscellaneous code and dynamic documents."
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "",
    "text": "What does the weighting by PPH4 do to tissue partitioned BMI instruments? Let’s simulate some tissue partitioned BMI MR results.\n\nlibrary(data.table)\nlibrary(ggplot2)\nlibrary(ggpubr)\nlibrary(ggrepel)\nlibrary(genepi.utils)\nlibrary(tibble)\nlibrary(knitr)"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#motivation",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#motivation",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "",
    "text": "What does the weighting by PPH4 do to tissue partitioned BMI instruments? Let’s simulate some tissue partitioned BMI MR results.\n\nlibrary(data.table)\nlibrary(ggplot2)\nlibrary(ggpubr)\nlibrary(ggrepel)\nlibrary(genepi.utils)\nlibrary(tibble)\nlibrary(knitr)"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#bmi-data",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#bmi-data",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "BMI data",
    "text": "BMI data\nFirst load the BMI GWAS.\n\nbmi    &lt;- readRDS(file.path(TPMR_DIR, \"output\", \"tmp_objects\", \"obj_bmi.RDS\"))\nclumps &lt;- clump(as.data.table(bmi), p1=5e-8, r2=0.001, kb=10000, plink2=PLINK2, plink_ref=UKBB_REFERENCE)[index==TRUE]\nbmi    &lt;- subset_gwas(bmi, clumps$rsid)\nkable(head(clumps, 5), caption = \"BMI lead variants\")\n\n\nBMI lead variants\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nrsid\nchr\nbp\nea\noa\neaf\nbeta\nse\np\nn\nncase\ntrait\nid\nstrand\nimputed\ninfo\nq\nq_p\ni2\nproxy_rsid\nproxy_chr\nproxy_bp\nproxy_ea\nproxy_oa\nproxy_eaf\nproxy_r2\nsnp\nindex\nclump\n\n\n\n\nrs10007906\n4\n31023610\nA\nC\n0.360300\n0.0133000\n0.0018000\n0\n686479\nNA\nbmi\ncombined_bmi_giant_ukb_annot.txt\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nrs10007906\nTRUE\n291\n\n\nrs1000940\n17\n5283252\nA\nG\n0.701300\n-0.0154000\n0.0018000\n0\n794558\nNA\nbmi\ncombined_bmi_giant_ukb_annot.txt\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nrs1000940\nTRUE\n142\n\n\nrs1007934\n14\n73463479\nA\nG\n0.415000\n-0.0120000\n0.0017000\n0\n692411\nNA\nbmi\ncombined_bmi_giant_ukb_annot.txt\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nrs1007934\nTRUE\n407\n\n\nrs10125137\n9\n118644190\nT\nC\n0.641786\n-0.0117273\n0.0020523\n0\n463005\nNA\nbmi\ncombined_bmi_giant_ukb_annot.txt\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nrs10125137\nTRUE\n811\n\n\nrs10131890\n14\n97258752\nA\nC\n0.950300\n-0.0222000\n0.0039000\n0\n691777\nNA\nbmi\ncombined_bmi_giant_ukb_annot.txt\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nrs10131890\nTRUE\n846"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#heart-failure-data",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#heart-failure-data",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Heart failure data",
    "text": "Heart failure data\nLoad the heart failure GWAS.\n\nhf &lt;- readRDS(file.path(TPMR_DIR, \"output\", \"tmp_objects\", \"obj_hf_allcause.RDS\"))\nhf &lt;- subset_gwas(hf, clumps$rsid)"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#harmonise-the-datasets",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#harmonise-the-datasets",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Harmonise the datasets",
    "text": "Harmonise the datasets\n\nh &lt;- MR(bmi, hf)\nkable(head(as.data.table(h),5), caption = \"Harmonised BMI:HF dataset\")\n\n\nHarmonised BMI:HF dataset\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nrsid\nchr\nbp\nea\noa\nbx\nbxse\npx\nby\nbyse\npy\nproxy_e_snp\nproxy_o_snp\nindex_snp\ngroup\nld_info\nexposure\noutcome\n\n\n\n\nrs10007906_C_A\n4\n31023610\nA\nC\n0.0133000\n0.0018000\n0\n0.0039\n0.0051\n0.44980\nNA\nNA\nTRUE\nNA\nFALSE\nbmi\nhf_allcause\n\n\nrs1000940_G_A\n17\n5283252\nA\nG\n-0.0154000\n0.0018000\n0\n0.0011\n0.0050\n0.82970\nNA\nNA\nTRUE\nNA\nFALSE\nbmi\nhf_allcause\n\n\nrs1007934_G_A\n14\n73463479\nA\nG\n-0.0120000\n0.0017000\n0\n-0.0092\n0.0049\n0.05931\nNA\nNA\nTRUE\nNA\nFALSE\nbmi\nhf_allcause\n\n\nrs10125137_C_T\n9\n118644190\nT\nC\n-0.0117273\n0.0020523\n0\n0.0033\n0.0049\n0.50820\nNA\nNA\nTRUE\nNA\nFALSE\nbmi\nhf_allcause\n\n\nrs10131890_C_A\n14\n97258752\nA\nC\n-0.0222000\n0.0039000\n0\n-0.0211\n0.0099\n0.03310\nNA\nNA\nTRUE\nNA\nFALSE\nbmi\nhf_allcause"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#run-the-mr",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#run-the-mr",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Run the MR",
    "text": "Run the MR\n\nres &lt;- run_mr(h)\nkable(res, caption = \"BMI:HF Mendelian randomisation\")\n\n\nBMI:HF Mendelian randomisation\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nmethod\ncorrelation\nexposure\noutcome\nn_snp\nb\nb_se\np\nintercept\nint_se\nint_p\nqstat\nqstat_p\nfstat\ncondfstat\noverdispersion\nn_pc\nn_hunted\nslopehunter_pi\nslopehunter_ent\n\n\n\n\nmr_ivw\nFALSE\nbmi\nhf_allcause\n874\n0.4872820\n0.0165599\n0\n0.0000000\nNA\nNA\n1592.460\n0\n60.70091\nNA\nNA\nNA\nNA\nNA\nNA\n\n\nmr_egger\nFALSE\nbmi\nhf_allcause\n874\n0.5367727\n0.0464790\n0\n-0.0008232\n0.0007224\n0.2544728\n1590.092\n0\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\nmr_weighted_median\nFALSE\nbmi\nhf_allcause\n874\n0.5078217\n0.0236696\n0\n0.0000000\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\nmr_weighted_mode\nFALSE\nbmi\nhf_allcause\n874\n0.5456300\n0.0523114\n0\n0.0000000\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#plot-mr",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#plot-mr",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Plot MR",
    "text": "Plot MR\n\nplot_mr(h, res)"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#select-variants---mr-with-a-subset-of-bmi-variants",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#select-variants---mr-with-a-subset-of-bmi-variants",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Select variants - MR with a subset of BMI variants",
    "text": "Select variants - MR with a subset of BMI variants\nIn the Leyden et al. 2022 paper 86 variant colocalise with adipose tissue eQTLs and 140 colocalise with brain tissue eQTLs. There is overlap between the two tissues of 43 variants.\n\nset.seed(123)\ntissue1_varid &lt;- sample(h@snps, 140)\noverlap_varid &lt;- sample(tissue1_varid, 43)\ntissue2_varid &lt;- c(overlap_varid, sample(h@snps[!h@snps %in% overlap_varid], 86-43))\n\n# turn of variants not in either tissue\nh@index_snp[!h@snps %in% c(tissue1_varid, tissue2_varid)] &lt;- FALSE\nh@exposure &lt;- \"BMI tissue 1/2 SNPs\"\n\nres1 &lt;- run_mr(h)\nkable(res1, caption = \"BMI:HF Mendelian randomisation (Tissue 1 & 2 SNPs only)\")\n\n\nBMI:HF Mendelian randomisation (Tissue 1 & 2 SNPs only)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nmethod\ncorrelation\nexposure\noutcome\nn_snp\nb\nb_se\np\nintercept\nint_se\nint_p\nqstat\nqstat_p\nfstat\ncondfstat\noverdispersion\nn_pc\nn_hunted\nslopehunter_pi\nslopehunter_ent\n\n\n\n\nmr_ivw\nFALSE\nBMI tissue 1/2 SNPs\nhf_allcause\n177\n0.5108471\n0.0363407\n0e+00\n0.0000000\nNA\nNA\n304.2402\n0\n61.28134\nNA\nNA\nNA\nNA\nNA\nNA\n\n\nmr_egger\nFALSE\nBMI tissue 1/2 SNPs\nhf_allcause\n177\n0.5475313\n0.1037260\n1e-07\n-0.0006034\n0.0015974\n0.7056336\n303.9924\n0\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\nmr_weighted_median\nFALSE\nBMI tissue 1/2 SNPs\nhf_allcause\n177\n0.5730810\n0.0494983\n0e+00\n0.0000000\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\nmr_weighted_mode\nFALSE\nBMI tissue 1/2 SNPs\nhf_allcause\n177\n0.5887868\n0.1022882\n0e+00\n0.0000000\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n\n\nplot_mr(h, res1)"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#run-multivariable-mr-unweighted",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#run-multivariable-mr-unweighted",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Run multivariable MR (unweighted)",
    "text": "Run multivariable MR (unweighted)\n\n# copy of BMI for tissue 1\nbmi_t1 &lt;- bmi\nbmi_t1@id &lt;- \"bmi tissue 1\"\nbmi_t1@trait &lt;- \"bmi tissue 1\"\n\n# copy of BMI for tissue 2\nbmi_t2 &lt;- bmi\nbmi_t2@id &lt;- \"bmi tissue 2\"\nbmi_t2@trait &lt;- \"bmi tissue 2\"\n\n# harmonise\nh_mvmr &lt;- MR(list(bmi_t1, bmi_t2), hf)\n\n# turn of variants not in either tissue\nh_mvmr@index_snp[!h_mvmr@snps %in% c(tissue1_varid, tissue2_varid)] &lt;- FALSE\n\nres2 &lt;- run_mr(h_mvmr, methods=\"mr_ivw\")\nkable(res2, caption = \"BMI:HF MV Mendelian randomisation\")\n\n\nBMI:HF MV Mendelian randomisation\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nmethod\ncorrelation\nexposure\noutcome\nn_snp\nb\nb_se\np\nintercept\nint_se\nint_p\nqstat\nqstat_p\nfstat\ncondfstat\noverdispersion\nn_pc\nn_hunted\nslopehunter_pi\nslopehunter_ent\n\n\n\n\nmr_mvivw\nFALSE\nbmi tissue 1\nhf_allcause\n177\n0.5108471\n0.0363407\n0\n0\nNA\nNA\n302.5116\n0\nNA\n0\nNA\nNA\nNA\nNA\nNA\n\n\nmr_mvivw\nFALSE\nbmi tissue 2\nhf_allcause\n177\n0.5108471\n0.0363407\n0\n0\nNA\nNA\n302.5116\n0\nNA\n0\nNA\nNA\nNA\nNA\nNA\n\n\n\n\nplot_mr(h_mvmr, res2)"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#eqtl-colocalising-bmi-variants",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#eqtl-colocalising-bmi-variants",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "eQTL colocalising BMI variants",
    "text": "eQTL colocalising BMI variants\n\nNumber of colocalising variants per tissue\n\ncoloc_thresh &lt;- 0.8\n\ncoloc_results &lt;- fread(file.path(TPMR_DIR, \"output\", \"tables\", \"coloc_results.tsv.gz\"))\ncoloc_counts &lt;- (coloc_results\n  [locus_trait==\"bmi\" & grepl(\"^bmi\", trait.x) & !grepl(\"^bmi|^hf_\", trait.y) & grepl(\"protein_coding\", gene_type.y)]\n  [, num_coloc_genes := sum(pph4&gt;coloc_thresh), by=trait.y]\n  [, .SD[which.max(pph4)], by=.(locus_index_rsid, trait.y)]\n  [, .(num_coloc_genes= num_coloc_genes[1],\n       num_coloc_pph4 = sum(pph4&gt;coloc_thresh),\n       mean_pph4      = mean(pph4),\n       mean_sample_n  = mean(sample_n.y)), by=c(tissue=\"trait.y\")]\n  [, tissue := factor(tissue, levels = tissue[order(-`num_coloc_pph4`)])]\n)\n\nggplot(coloc_counts, aes(y = tissue, x = `num_coloc_pph4`)) +\n  theme_classic() +\n  geom_col(fill= \"blue\", alpha = 0.3) +\n  labs(subtitle = paste(\"coloc thresh:\", coloc_thresh), \n       x = \"Number of colocalising BMI variants\") +\n  theme(axis.title.y = element_blank())\n\n\n\n\n\n\n\n\n\n\nDeterminants of colocalisation number\nDoes this depend on eqtl sample size????\n\nggplot(coloc_counts, aes(y = mean_sample_n, x = num_coloc_pph4, color = mean_pph4, size = num_coloc_genes)) +\n  geom_point() +\n  geom_text_repel(aes(label = tissue), size = 2, color=\"black\", max.overlaps = Inf) +\n  scale_color_viridis_c(option=\"mako\") +\n  theme_classic() +\n  labs(subtitle = paste(\"coloc thresh:\", coloc_thresh),\n       color = \"Mean PPH4\",\n       size = \"No. coloc genes\",\n       y = \"No. colocalising BMI variants\",\n       x = \"Sample size\")\n\n\n\n\n\n\n\n\n\n\nEffect of number of colocalising loci on MVMR result - 1\nSimple analysis: hold constant the number of colocalising variants in tissue 1 (set to median: 73) and hold the PPH4 weighting for colocalising variants at 0.9 and the for the non-colocalising variants at 0.2.\n\nnum_loci &lt;- expand.grid(num_t1  = round(median(coloc_counts$num_coloc_pph4)), \n                        num_t2  = seq(min(coloc_counts$num_coloc_pph4), max(coloc_counts$num_coloc_pph4)),\n                        pph4_hi = 0.9, \n                        pph4_lo = 0.2) |&gt; as.data.table()\n\nunique_num_loci &lt;- sort(unique(c(num_loci$num_t1, num_loci$num_t2)))\nunique_num_loci &lt;- setNames(unique_num_loci, as.character(unique_num_loci))\n\nloci_indicies &lt;- lapply(unique_num_loci, function(num_l) {\n  set.seed(123)\n  sample(1:length(h_mvmr@snps), num_l, replace = FALSE)\n})\n\nmr_num_loci &lt;- num_loci[, {\n  h_tmp   &lt;- copy(h_mvmr)\n  t1_incides &lt;- loci_indicies[[as.character(num_t1)]]\n  t2_incides &lt;- loci_indicies[[as.character(num_t2)]]\n  h_tmp@index_snp &lt;- ifelse(1:length(h_tmp@snps) %in% union(t1_incides, t2_incides), TRUE, FALSE) \n  h_tmp@bx[t1_incides,1] &lt;- h_tmp@bx[t1_incides,1] * pph4_hi\n  h_tmp@bx[t2_incides,2] &lt;- h_tmp@bx[t2_incides,2] * pph4_hi\n  h_tmp@bx[setdiff(t2_incides, t1_incides),1] &lt;- h_tmp@bx[setdiff(t2_incides, t1_incides),1] * pph4_lo\n  h_tmp@bx[setdiff(t1_incides, t2_incides),2] &lt;- h_tmp@bx[setdiff(t1_incides, t2_incides),2] * pph4_lo\n  h_tmp@exposure &lt;- c(\"Tissue 1\", \"Tissue 2\")\n  r &lt;- run_mr(h_tmp, methods=\"mr_ivw\")\n}, by = .(num_t1, num_t2)]\n\nggplot(mr_num_loci[, `:=`(b_lb = b-b_se*1.96, \n                          b_ub = b+b_se*1.96)],\n       aes(x=num_t2, y=b, ymin=b_lb, ymax=b_ub, color=exposure)) +\n  geom_errorbar(width=0.2, position = position_dodge(0.2)) +\n  geom_point(position = position_dodge(0.2)) +\n  theme_bw() +\n  labs(y = \"MVMR estimate (tpBMI vs HF)\", \n       x = \"Number of tissue 2 loci\", \n       color = \"Tissue\", \n       subtitle = paste0(\"Number of loci for tissue 1 fixed at \", num_loci$num_t1[1]))\n\n\n\n\n\n\n\n\n\n\nEffect of number of colocalising loci on MVMR result - 2\nNow do the same but vary both the number of colocalising variants in tissue 1 and 2 (grid search).\n\nnum_loci &lt;- expand.grid(num_t1  = seq(min(coloc_counts$num_coloc_pph4), max(coloc_counts$num_coloc_pph4), 50), \n                        num_t2  = seq(min(coloc_counts$num_coloc_pph4), max(coloc_counts$num_coloc_pph4), 50),\n                        overlap = seq(0, 1, 0.2),\n                        seed    = 2000:2100,\n                        pph4_hi = 0.9, \n                        pph4_lo = 0.1) |&gt; as.data.table()\n\nlibrary(future)\nlibrary(furrr)\nplan(multisession)\nmr_num_loci &lt;- future_pmap_dfr(num_loci, function(num_t1, num_t2, overlap, seed, pph4_hi, pph4_lo) {\n  \n  h_tmp   &lt;- copy(h_mvmr)\n  \n  # randomly sort the BMI SNP indices\n  set.seed(seed)\n  sram_idx &lt;- sample.int(length(h_mvmr@snps))\n  \n  # indicies of the variants to use\n  overlap_n &lt;- round(min(num_t1, num_t2) * overlap)\n  t1i       &lt;- sram_idx[1:num_t1]\n  t2i       &lt;- sram_idx[(num_t1-overlap_n+1):(num_t2 + num_t1-overlap_n)]\n  t12i      &lt;- intersect(t1i, t2i)  # both tissues\n  ut1i      &lt;- setdiff(t1i, t12i)   # only tissue 1\n  ut2i      &lt;- setdiff(t2i, t12i)   # only tissue 2\n  \n  # which snps go into the instrument\n  h_tmp@index_snp &lt;- 1:length(h_mvmr@snps) %in% c(t12i, ut1i, ut2i)\n  \n  # weight tissue 1 betas\n  h_tmp@bx[ut2i,1] &lt;- h_tmp@bx[ut2i,1] * pph4_lo \n  h_tmp@bx[t1i,1]  &lt;- h_tmp@bx[t1i,1] * pph4_hi \n  \n  # weight tissue 2 betas\n  h_tmp@bx[ut1i,2] &lt;- h_tmp@bx[ut1i,2] * pph4_lo \n  h_tmp@bx[t2i,2]  &lt;- h_tmp@bx[t2i,2] * pph4_hi \n  \n  # naming\n  h_tmp@exposure &lt;- c(\"MV-beta tissue 1\", \"MV-beta tissue 2\")\n  \n  # run mr\n  r &lt;- run_mr(h_tmp, methods=\"mr_ivw\")\n  \n  r[, `:=`(num_t1   = num_t1, \n           num_t2   = num_t2, \n           num_diff = num_t1-num_t2, \n           overlap  = overlap, \n           seed     = seed, \n           pph4_lo  = pph4_lo, \n           pph4_hi  = pph4_hi)]\n  \n  return(r)\n})\n\n\n# ggplot(mr_num_loci, aes(x=as.factor(num_diff), y=b, fill=exposure, color=num_t1)) +\n#   geom_hline(yintercept = 0.0, linetype=\"dashed\", color=\"darkgray\") +\n#   geom_violin(width=1, position= position_dodge(width = 0.5), color=NA) +\n#   theme_classic() +\n#   labs(x = \"Difference in instrument size (num SNPs, T1-T2)\", \n#        y = \"MVMR estimate\", \n#        fill = \"Tissue\") +\n#   facet_wrap(~overlap, \n#              labeller = labeller(overlap = function(x) paste0(\"Loci overlap: \", scales::percent(as.numeric(x)))))\n\n\nggplot(mr_num_loci[, num_diff_lab := paste0(\"Delta~nSNP[T1-T2]:~ \", num_diff)], \n       aes(x=as.factor(overlap), y=b, fill=exposure, color=num_t1)) +\n  geom_hline(yintercept = 0.0, linetype=\"dashed\", color=\"darkgray\") +\n  geom_violin(width=1, position= position_dodge(width = 0.5), color=NA) +\n  scale_x_discrete(labels = function(x) scales::percent(as.numeric(x))) +\n  theme_classic() +\n  theme(legend.position = \"top\") +\n  labs(x = \"Instrument SNP overlap (% of smaller instrument)\", \n       y = \"MVMR estimate\", \n       fill = \"Tissue\") +\n  facet_wrap(~num_diff_lab, \n             nrow = 1,\n             labeller = label_parsed)"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#bmieqtl-pph4-distributions-by-tissue",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#bmieqtl-pph4-distributions-by-tissue",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "BMI:eQTL PPH4 distributions by tissue",
    "text": "BMI:eQTL PPH4 distributions by tissue\nNow lets look at the actual distributions of the PPH4 values in each tissue, since they are not fixed like in the above analyses. Take the maximum PPH4 from genes in close proximity to each variant, in each tissue and plot the distributions - these are the weights that would be used in the tissue-partitioned MR procedure.\n\nnum_tissues &lt;- 6\ntissues_subset &lt;- levels(coloc_counts$tissue)[as.integer(seq(1, length(levels(coloc_counts$tissue)), length.out=num_tissues))] \ncoloc_subset &lt;- coloc_results[locus_trait==\"bmi\" & trait.x==\"bmi\" & (trait.y %in% tissues_subset), .SD[which.max(pph4)], by=.(locus_index_rsid,trait.y)]\n\ndensity &lt;- coloc_subset[, {\n  den &lt;- density(pph4, n=1000)\n  .(pph4 = scales::rescale(den$x, 0:1), prob = den$y)\n}, by = c(tissue=\"trait.y\")][, tissue := factor(tissue, levels = levels(coloc_counts$tissue))]\n\nggplot(density, aes(x=pph4, y=prob, color=tissue)) +\n  theme_classic() +\n  geom_line() +\n  labs(y = \"Density\")"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#use-of-these-distributions-in-simulations",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#use-of-these-distributions-in-simulations",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Use of these distributions in simulations",
    "text": "Use of these distributions in simulations\nIf we want ‘real-world’ PPH4 weights for use in simulations we can just sample from these density distributions. Here is a quick check to show that sampling from them replicates the shape.\n\ntissues &lt;- expand.grid(tissue = unique(density$tissue), stringsAsFactors = F) |&gt; as.data.table()\n\nset.seed(123)\n\nres_sim_density &lt;- tissues[, {\n  .(sim_pph4 = sample(density[tissue==.BY$tissue, pph4], round(length(h_mvmr@bx[,1])/2), prob = density[tissue==.BY$tissue, prob], replace = TRUE))\n}, by = .(tissue)]\n\n\nggplot(res_sim_density, aes(x=sim_pph4, color=tissue)) +\n  theme_classic() +\n  geom_density() +\n  labs(y = \"Simulated density\", \n       x = \"Simulated PPH4\", \n       color = \"Tissue\")"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#effect-different-pph4-weights",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#effect-different-pph4-weights",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Effect different PPH4 weights",
    "text": "Effect different PPH4 weights\nWeight the BMI betas by their respective maximum PPH4 value, see how this changes the relationship between the beta for BMI and beta for HF, dependent on which tissue is providing the betas. Tissues with greater or fewer colocalising variants affect push the betas up or down more, respectively. I hold one tissue constant (reference) to more easily appreciate how the other tissue’s colocalisation characteristics affect things.\n\nref_tissue   &lt;- levels(density$tissue)[1]\ntissue_pairs &lt;- expand.grid(t1 = ref_tissue, t2 = unique(density$tissue), stringsAsFactors = F) |&gt; as.data.table()\n\nset.seed(123)\nt1_pph4 &lt;- sample(density[tissue==ref_tissue, pph4], length(h_mvmr@bx[,1]), prob = density[tissue==ref_tissue, prob], replace = TRUE)\n\nres_weighted &lt;- tissue_pairs[, {\n  h_tmp &lt;- h_mvmr\n  t2_pph4 &lt;- sample(density[tissue==.BY$t2, pph4], length(h_tmp@bx[,1]), prob = density[tissue==.BY$t2, prob], replace = TRUE)\n  h_tmp@bx[,1] &lt;- h_tmp@bx[,1] * t1_pph4\n  h_tmp@bx[,2] &lt;- h_tmp@bx[,2] * t2_pph4\n  h_tmp@index_snp &lt;- ifelse(t1_pph4&gt;coloc_thresh | t2_pph4&gt;coloc_thresh, TRUE, FALSE)\n  .(tissue   = rep(c(paste0(\"Ref: \", ref_tissue),\"Comparator\"), each=sum(h_tmp@index_snp)), \n    beta_bmi = c(h_tmp@bx[h_tmp@index_snp,1], h_tmp@bx[h_tmp@index_snp,2]), \n    beta_hf  = rep(h_tmp@by[h_tmp@index_snp],2),\n    mean_pph4_t1 = mean(t1_pph4[t1_pph4&gt;coloc_thresh | t2_pph4&gt;coloc_thresh]),\n    mean_pph4_t2 = mean(t2_pph4[t1_pph4&gt;coloc_thresh | t2_pph4&gt;coloc_thresh]), \n    rmse_pph4    = sqrt(mean((t1_pph4[t1_pph4&gt;coloc_thresh | t2_pph4&gt;coloc_thresh] - t2_pph4[t1_pph4&gt;coloc_thresh | t2_pph4&gt;coloc_thresh])^2))\n   )\n}, by = .(t1,t2)]\nres_weighted[, t2 := factor(t2, levels = unique(t2[order(-mean_pph4_t1)]))]\n\nggplot(res_weighted, aes(x=beta_bmi, y=beta_hf, color=tissue)) +\n  geom_point() +\n  geom_text(data = unique(res_weighted[grepl(\"Ref\", tissue)], by=\"t2\"), \n            aes(x = 0.0, \n                y = -0.04,\n                label = sprintf(\"Tis mPPH4=%.3f\", mean_pph4_t2)),\n            color=\"black\", size=2) +\n  geom_text(data = unique(res_weighted[!grepl(\"Ref\", tissue)], by=\"t2\"), \n            aes(x = 0.0, \n                y = -0.07,\n                label = sprintf(\"Ref mPPH4=%.3f\", mean_pph4_t1)),\n            color=\"black\", size=2) +\n  geom_smooth(method=\"lm\", se=F,fullrange = TRUE) +\n  facet_wrap(~t2, labeller = labeller(t2 = function(x) gsub(\"_\", \" \", x))) +\n  labs(subtitle = paste(\"coloc thresh:\", coloc_thresh), \n       y = \"Heart failure beta\", \n       x = \"BMI beta (PPH4-weighted)\", \n       color = \"Tissue\")"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#ivw-regression-by-different-pph4-weighting-distributions",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#ivw-regression-by-different-pph4-weighting-distributions",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "IVW regression by different PPH4 weighting distributions",
    "text": "IVW regression by different PPH4 weighting distributions\nPerform MVMR with the weighted BMI instruments. Lets look at holding a poorly colocalising tissue constant compared to the best colocalising tissues.\n\nFunction to weight betas and run MR\n\n#' @title TPMR helper function\n#' @param mrobj genepi.utils MR object (exposures BMI:BMI, outcome HF)\n#' @param density data.table of PPH4 density distributions cols: tissue | pph4 | prob\n#' @param ref character vector, tissues in density$tissue\n#' @param comp character vector, tissues in density$tissue\n#' @param coloc_thresh numeric 0-1\n#' @param rep integer, number of replications (random sampling of BMI variants into instrument)\n#' @returns data.table of MR results\n#'\ntpmr &lt;- function(obj, ref, comp, coloc_thresh, rep = 1, density = NULL, pph4 = NULL) {\n  \n  # either density or actual PPH4 values\n  stopifnot(\"Provide either denisty distributions or actual PPH4 values\" = \n              sum(sapply(list(density, pph4), is.null)) == 1)\n  stopifnot(\"Replications must be 1 if using actual PPH4 values\" = ifelse(rep &gt; 1 & !is.null(pph4), F, T))\n              \n  # run the MR for each of the exposure combinations\n  tissue_pairs &lt;- expand.grid(t1 = as.character(ref), \n                              t2 = as.character(comp),\n                              seed = 2000:(2000+rep-1),\n                              stringsAsFactors = F) |&gt; as.data.table()\n  \n  library(future)\n  library(furrr)\n  plan(multisession)\n  mr_weighted &lt;- future_pmap_dfr(tissue_pairs, function(t1, t2, seed) {\n    \n    mrobj &lt;- copy(obj)\n    \n    if (!is.null(density)) {\n    \n      # generate the PPH4 values randomly for the variants\n      set.seed(seed)\n      t1_pph4 &lt;- sample(density[tissue==t1, pph4], length(mrobj@snps), prob = density[tissue==t1, prob], replace = TRUE)\n      set.seed(seed+1)\n      t2_pph4 &lt;- sample(density[tissue==t2, pph4], length(mrobj@snps), prob = density[tissue==t2, prob], replace = TRUE)\n     \n    } else if(!is.null(pph4)) {\n      \n      chrpos &lt;- data.table(chr = as.integer(mrobj@chr), bp = mrobj@bp, t1 = t1, t2 = t2)\n      chrpos[pph4, t1.pph4 := i.pph4, on=c(\"chr\"=\"chr\",\"bp\"=\"bp\",\"t1\"=\"tissue\")]\n      chrpos[pph4, t2.pph4 := i.pph4, on=c(\"chr\"=\"chr\",\"bp\"=\"bp\",\"t2\"=\"tissue\")]\n      t1_pph4 &lt;- chrpos$t1.pph4\n      t2_pph4 &lt;- chrpos$t2.pph4\n      t1_pph4[is.na(t1_pph4)] &lt;- 0\n      t2_pph4[is.na(t2_pph4)] &lt;- 0\n      \n    }\n    \n    # based on the distribution of PPH4, which SNPs are included\n    include &lt;- ifelse(t1_pph4 &gt; coloc_thresh | t2_pph4 &gt; coloc_thresh, TRUE, FALSE)\n    \n    # update the MR object, turn off the excluded snps (@index_snp slot)\n    mrobj@bx[,1]      &lt;- mrobj@bx[,1] * t1_pph4\n    mrobj@bx[,2]      &lt;- mrobj@bx[,2] * t2_pph4\n    mrobj@index_snp   &lt;- include\n    mrobj@exposure[1] &lt;- ifelse(length(ref)==1, paste0(\"Ref: \", ref_tissue), \"Tissue 1\")\n    mrobj@exposure[2] &lt;- ifelse(length(ref)==1, \"Comparator\", \"Tissue 2\")\n    \n    # run the MR\n    r &lt;- run_mr(mrobj, methods=\"mr_ivw\")\n    \n    # add info about the instrument used\n    r[, `:=`(t1             = t1, \n             t2             = t2,\n             seed           = seed,\n             n_sig_snps     = c(sum(t1_pph4 &gt; coloc_thresh), sum(t2_pph4 &gt; coloc_thresh)), \n             n_overlap_snps = sum(t1_pph4 &gt; coloc_thresh & t2_pph4 &gt; coloc_thresh),\n             pct_t1_overlap = sum(t1_pph4 &gt; coloc_thresh & t2_pph4 &gt; coloc_thresh) / length(t1_pph4),\n             mean_pph4_t1   = mean(t1_pph4[include]),\n             mean_pph4_t2   = mean(t2_pph4[include]),\n             rmse_pph4      = sqrt(mean((t1_pph4[include] - t2_pph4[include])^2)), \n             rmse_wbeta     = sqrt(mean((mrobj@bx[,1] - mrobj@bx[,2])^2)))]\n    r[, c(\"overdispersion\", \"n_pc\", \"n_hunted\", \"slopehunter_pi\", \"slopehunter_ent\") := NULL]\n    \n  })\n  \n  return(mr_weighted)\n}\n\n\n\nDifferent PPH4 distributions against each other\n\n# run TPMR\nmr_weighted &lt;- tpmr(obj=h_mvmr, density=density, \n                    ref= unique(density$tissue), \n                    comp=unique(density$tissue), \n                    coloc_thresh=0.8, \n                    rep = 100)\n\n# reorder for plotting \nmr_weighted[, mean_pph4_t1_lab := round(mean(mean_pph4_t1),2), by=.(t1)]\nmr_weighted[, mean_pph4_t2_lab := round(mean(mean_pph4_t2),2), by=.(t2)]\nmr_weighted[, mean_n_sig_snps := round(mean(mean_pph4_t2),0), by=.(t1,t2)]\n\nggplot(mr_weighted, \n       aes(x=as.factor(mean_pph4_t2_lab), y=b, color=exposure)) +\n  geom_boxplot() +\n  theme_bw() +\n  labs(y = \"MVMR estimate\", x = \"T2 mean PPH4\", color = \"Tissue\") +\n  facet_wrap(~ as.factor(mean_pph4_t1_lab), \n             labeller = labeller(`as.factor(mean_pph4_t1_lab)`=function(x) paste0(\"T1 mean PPH4: \",x)))\n\n\n\n\n\n\n\nggplot(mr_weighted[, .(b=mean(b)), by=.(t1,t2,exposure)][, .(b_diff=b[1]-b[2]), by=.(t1,t2)], \n       aes(y=t1, x=t2, fill=b_diff)) +\n  geom_tile() +\n  scale_fill_gradient2() +\n  theme(axis.text.x  = element_text(angle=45, hjust=1)) +\n  labs(y = \"Tissue 1\", x = \"Tissue 2\", fill = \"T1-T2 beta diff\")"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#all-tissue-pairs-mr-actual-pph4-values",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#all-tissue-pairs-mr-actual-pph4-values",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "All tissue pairs MR (actual PPH4 values)",
    "text": "All tissue pairs MR (actual PPH4 values)\n\ntissue_pph4_vals &lt;- coloc_results[locus_trait==\"bmi\" & \n                                    trait.x==\"bmi\" & \n                                    gene_type.y==\"protein_coding\", \n                                  .SD[which.max(pph4)], \n                                  by=.(locus_index_rsid, tissue=trait.y), \n                                  .SDcols=c(\"chr\", \"bp\", \"pph4\")]\ntissue_pph4_vals &lt;- tidyr::complete(tissue_pph4_vals, locus_index_rsid, tissue) |&gt; as.data.table()\n\nmr_actual &lt;- tpmr(obj=h_mvmr, pph4=tissue_pph4_vals, \n                  ref= unique(tissue_pph4_vals$tissue), \n                  comp=unique(tissue_pph4_vals$tissue), \n                  coloc_thresh=0.8)\n\nggplot((mr_actual\n        [coloc_counts, t1_n := i.mean_sample_n, on=c(\"t1\"=\"tissue\")]\n        [coloc_counts, t2_n := i.mean_sample_n, on=c(\"t2\"=\"tissue\")]\n        [, `:=`(b_diff     = b[exposure==\"Tissue 1\"]-b[exposure==\"Tissue 2\"],\n                snp_diff   = n_sig_snps[exposure==\"Tissue 1\"]-n_sig_snps[exposure==\"Tissue 2\"],\n                pph4_diff  = mean_pph4_t1-mean_pph4_t2, \n                nsamp_diff = t1_n - t2_n), by=.(t1,t2)]\n        [, `:=`(t1 = factor(t1, levels = unique(t1[order(-b_diff)])),\n                t2 = factor(t2, levels = unique(t1[order(-b_diff)])))]),\n       aes(y=t1, x=t2, fill=b_diff)) +\n  geom_tile() +\n  scale_fill_gradient2() +\n  theme(axis.text.x  = element_text(angle=45, hjust=1)) +\n  labs(y = \"Tissue 1\", x = \"Tissue 2\", fill = \"T1-T2 beta diff\")\n\n\n\n\n\n\n\n\n\nMVMR estimates depend on difference in instrument size (which also depends on difference in sample size)\n\nggplot((mr_actual\n        [coloc_counts, t1_n := i.mean_sample_n, on=c(\"t1\"=\"tissue\")]\n        [coloc_counts, t2_n := i.mean_sample_n, on=c(\"t2\"=\"tissue\")]\n        [, `:=`(b_diff     = b[exposure==\"Tissue 1\"]-b[exposure==\"Tissue 2\"],\n                snp_diff   = n_sig_snps[exposure==\"Tissue 1\"]-n_sig_snps[exposure==\"Tissue 2\"],\n                pph4_diff  = mean_pph4_t1-mean_pph4_t2, \n                nsamp_diff = t1_n - t2_n), by=.(t1,t2)]\n       ),\n       aes(y=b_diff, x=snp_diff, color=nsamp_diff)) +\n  geom_hline(yintercept = 0.0, linetype=\"dotted\", color=\"grey\") +\n  geom_vline(xintercept = 0.0, linetype=\"dotted\", color=\"grey\") +\n  geom_point(alpha=0.3) +\n  scale_color_viridis_c(option=\"magma\") +\n  geom_smooth(method=\"lm\", se=FALSE, color=\"red\") +\n  theme_classic2() +\n  theme(legend.position = \"top\") +\n  labs(y = expression(Delta[T1-T2]~MVMR~estimate), \n       x = expression(Delta[T1-T2]~No.~coloc~SNPs), \n       color = expression(Delta[T1-T2]~Tissue~sample~size))"
  },
  {
    "objectID": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#interpretation",
    "href": "posts/2025-01-10-tissue-partitioned-mvmr/index.html#interpretation",
    "title": "Tissue-partitioned BMI instrument procedure",
    "section": "Interpretation",
    "text": "Interpretation\nIs the MVMR estimate mostly related to the difference in the relative number of colocalising SNPs in tissue A vs. tissue B? The tissue with fewer colocalising SNPs will liekly be overpowered in the MVMR by the tissue with a greater number of colocalising SNPs. Yet, the number of colocalising SNPs is closely related to the sample size of the eQTL dataset."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Nick Sunderland's lab book",
    "section": "",
    "text": "Date\n\n\nTitle\n\n\nCategories\n\n\n\n\n\n\nJan 10, 2025\n\n\nTissue-partitioned BMI instrument procedure\n\n\n \n\n\n\n\n\nNo matching items"
  }
]